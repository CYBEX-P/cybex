

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Overview &mdash; cybex_web_app 0.9.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> cybex_web_app
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="README.html">Overview</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">cybex_web_app</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/Home.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>Welcome to the Privacy Preservation wiki!</p>
<div class="section" id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h1>
<p>Privacy preserving information sharing. This project aims to share data with only the parties that meet certain attributes. In this model no party is truxted with the exeption of the oneself and the Key Distribution Service(KMS). This sharing of Information is as follows:</p>
<ol class="simple">
<li><p>An organization enrolls in the system via KMS</p>
<ul class="simple">
<li><p>KMS generates secrets keys for that party</p></li>
</ul>
</li>
<li><p>Enrolled organizations deploy collector with their desired encryption policies</p>
<ul class="simple">
<li><p>Organizations share encrypted information (using deterministic and CPABE encryption)</p>
<ul>
<li><p>to be stored by untrusted party</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Organizations can request/query the storage server for encrypted data</p>
<ul class="simple">
<li><p>organization will only be able to decrypt if their attributes matches the encryption policy for that data(field wise)</p></li>
<li><p>this is enforced with CPABE encryption</p></li>
</ul>
</li>
</ol>
<p>This project was built using docker. For help regathering docker please visit <a class="reference external" href="https://docs.docker.com/">docker docs</a>.</p>
<div class="section" id="structure">
<h2>Structure<a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h2>
<p>Structure of the overall project is as follows
<img alt="overview" src="images/overview-v2.png" /></p>
<p>The system has 4 parts. The collector is in charge of encrypting the data with the encryption policy set by the organization that wants to share the data. The collector has two parts, the encryption module and the gatherer, the encryption module just encrypts any data sent to it by one or more gatherers(they just collect the data) and ships it over encrypted to the backend DB.</p>
<p>The backend/API/DB just collects the encrypted data and stores it into a DB. when the system is queried it returns applicable data, using DE and ORE encryptions.</p>
<p>The query client just handles queries from a user. It handles all processing to carry out this operations, that is, the encryption of the query, the query itself, and the decryption of the data. A user queries with the query client which will and it outputs data. The user querying will only be able to decrypt data that the original encrypting user desired, this is enforced with CPABE.</p>
<p>The KMS handles key creation for new members of the system. This also includes attributes, new keys are generated based on a users/orgs attributes. Keys with attributes allow users to decrypt information that the encrypting user desired. The KMS is used by the collector to get the public keys when encrypting, by the administrator when setting up the collectors policy to determine available attributes, by the backend to retrieve the ORE key to filter requests numerically, by the query client to get private keys for decryption purposes. The KMS server is not needed at runtime if keys are preloaded and stored locally by each software, in this case, KMS is only used for key creation.</p>
</div>
<div class="section" id="images-layout">
<h2>Images Layout<a class="headerlink" href="#images-layout" title="Permalink to this headline">¶</a></h2>
<p>Layout of the docker images<br />
<img alt="docker_images_layout" src="images/docker_images.png" /></p>
<p>The privacy library image is the base image for all other modules.</p>
</div>
</div>
<div class="section" id="descriptions">
<h1>Descriptions<a class="headerlink" href="#descriptions" title="Permalink to this headline">¶</a></h1>
<div class="section" id="privacy-libraries">
<h2>Privacy libraries<a class="headerlink" href="#privacy-libraries" title="Permalink to this headline">¶</a></h2>
<p>This image is the base image for the other images. This image contains:</p>
<ul class="simple">
<li><p>Base encryption libraries</p>
<ul>
<li><p>Deterministic encryption</p></li>
<li><p>Order Revealing Encryption (ORE)</p></li>
<li><p>Ciphertext-Policy Attribute-Based Encryption (CPABE)</p></li>
</ul>
</li>
<li><p>Encryption tests</p></li>
<li><p>Key generation</p></li>
<li><p>Functions to communicate with APIs on the system</p></li>
<li><p>Other common functions</p>
<ul>
<li><p>Database manager</p></li>
<li><p>File manager</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="collector">
<h2>Collector<a class="headerlink" href="#collector" title="Permalink to this headline">¶</a></h2>
<p>This module contains two sudmodules:</p>
<ol class="simple">
<li><p>The collector, which handles encryption</p></li>
<li><p>Collector-client, which ship JSON logs to the collector</p></li>
</ol>
<p>In this case this collector-client grabs a JSON file and ships it to the collector. Keep in mind that this client can be anything in the organization premise as long as it can send JSON via a TCP socket (one record per connection).</p>
<p>The wrapper script for this module can also query the KMS for possible attributes. This helps for determining possible values for the encryption policy.</p>
</div>
<div class="section" id="kms">
<h2>KMS<a class="headerlink" href="#kms" title="Permalink to this headline">¶</a></h2>
<p>This module handles:</p>
<ul class="simple">
<li><p>Key creation</p></li>
<li><p>Key distribution</p></li>
<li><p>Attribute management</p></li>
</ul>
<p>The API is detailed TODO <span class="xref myst">here</span>.</p>
<p>This module requires a Mongo database. The wrapper script initializes runs a MngoDB image. If that is not desired then one can modify the <code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code> file and comment out the database section(alternatively use the deprecated script). With the database commented out, we can now edit the config file and specify another Mongo database URI.</p>
</div>
<div class="section" id="backend-api">
<h2>Backend API<a class="headerlink" href="#backend-api" title="Permalink to this headline">¶</a></h2>
<p>This module is the interface for the following functions:</p>
<ul class="simple">
<li><p>Storage of encrypted data</p></li>
<li><p>Retrieval of encrypted data</p>
<ul>
<li><p>Encrypted data filtering</p></li>
</ul>
</li>
</ul>
<p>The API is detailed TODO <span class="xref myst">here</span>.</p>
<p>This module requires a Mongo database. The wrapper script initializes runs a MngoDB image. If that is not desired then one can modify the <code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code> file and comment out the database section(alternatively use the deprecated script). With the database commented out, we can now edit the config file and specify another Mongo database URI.</p>
</div>
<div class="section" id="query">
<h2>Query<a class="headerlink" href="#query" title="Permalink to this headline">¶</a></h2>
<p>This module allows us to:</p>
<ul class="simple">
<li><p>query the backend API</p>
<ul>
<li><p>query with time range</p>
<ul>
<li><p>&lt;, &lt;=, &gt;, &gt;=</p></li>
</ul>
</li>
<li><p>retrieval of encrypted data</p></li>
</ul>
</li>
<li><p>decrypt encrypted data, CPABE permitting</p></li>
</ul>
</div>
<div class="section" id="wrapper-scripts">
<h2>Wrapper scripts<a class="headerlink" href="#wrapper-scripts" title="Permalink to this headline">¶</a></h2>
<p>These scripts help build, create containers, run, and remove the project images. There is one per module as follows:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Module</p></th>
<th class="head"><p>Script</p></th>
<th class="head"><p>Capabilities</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>prib-libs</p></td>
<td><p>build.sh, build-run-shell.sh</p></td>
<td><p>build, run shell</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Collector</p></td>
<td><p>collector.sh</p></td>
<td><p>build, run, shell, remove</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>KMS</p></td>
<td><p>kms.sh</p></td>
<td><p>build, run, remove</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Query</p></td>
<td><p>query.sh</p></td>
<td><p>build, run,shell, remove</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>Backend API</p></td>
<td><p>backend.sh</p></td>
<td><p>build, run, remove</p></td>
</tr>
</tbody>
</table>
<p>To run wrapper scripts, please execute from the folder it is located e.i. cd into the folder before executing it.</p>
<p>Please add user to <code class="docutils literal notranslate"><span class="pre">docker</span></code> group. Run scripts without <code class="docutils literal notranslate"><span class="pre">sudo</span></code>, scrips will ask to elevate only when its needed. Adding user to the group is highly recommended as it will prevent executing code elevated when not needed and it will also not ask to elevate, therefore no user intervention.</p>
<p>Simpler deprecated scripts also provided in the respective <code class="docutils literal notranslate"><span class="pre">deprecated-scrips</span></code> folder. To use, move script into the root of the module and execute.</p>
</div>
</div>
<div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<ol class="simple">
<li><p>Install dependencies</p></li>
<li><p>Build images or fetch images</p></li>
<li><p>Configure parts</p></li>
<li><p>Run each part</p></li>
</ol>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<p>This project has multiple dependencies, these are handled by the dockerfiles when the images are built. As long as the there is internet access while building the images, the project will handle its own dependencies.</p>
<p>Here is a list of dependencies for this project:</p>
<ul class="simple">
<li><p>bash (installed in most systems already)</p></li>
<li><p><a class="reference external" href="https://docs.docker.com/engine/install/">Docker</a></p></li>
<li><p><a class="reference external" href="https://docs.docker.com/compose/install/">docker-compose</a></p></li>
</ul>
<p>These are widely used packeges, therefore they are available for almost every distribution. Please consult with your distribution for more information on how to install these for your machine.</p>
<div class="section" id="other-requirements">
<h3>Other Requirements<a class="headerlink" href="#other-requirements" title="Permalink to this headline">¶</a></h3>
<div class="section" id="linux">
<h4>Linux<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h4>
<p>Linux machine is required to run this project. Even though Docker grants us the ability to port projects, in this case our build procedure only supports Linux at the moment.</p>
</div>
<div class="section" id="docker-group">
<h4>Docker group<a class="headerlink" href="#docker-group" title="Permalink to this headline">¶</a></h4>
<p>It is recommended to add the user that will be running the wrapper scripts to the <code class="docutils literal notranslate"><span class="pre">docker</span></code> user group. This will allow the script to connect to the docker socket without the need to elevate privileges (e.g. sudo). The wrapper scripts automatically detect whether or not the user is part of the group and executes commands accordingly. The <code class="docutils literal notranslate"><span class="pre">root</span></code> user can skip this section.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># login as the user that will be executing the wrapper scripts</span>

<span class="c1"># add the docker group if it doesnt exist</span>
<span class="c1"># check existence with</span>
cat /etc/group <span class="p">|</span> grep docker

<span class="c1"># create group</span>
sudo groupadd docker

<span class="c1"># add current user to docker group</span>
sudo usermod -aG docker <span class="nv">$USER</span>
</pre></div>
</div>
<p>For group changes to take effect, logout the user and log back in. Then lets check if it worked.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if docker service is running </span>
sudo systemctl status docker
<span class="c1"># start docker service if already not running</span>
sudo systemctl start docker

<span class="c1"># check if we can execute docker without sudo</span>
docker run hello-world
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="building-images">
<h2>Building images<a class="headerlink" href="#building-images" title="Permalink to this headline">¶</a></h2>
<div class="section" id="image-names">
<h3>Image names<a class="headerlink" href="#image-names" title="Permalink to this headline">¶</a></h3>
<p>The following names are useful if wishing to handle image building and container creation manually or when using the deprecated scripts:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Module</p></th>
<th class="head"><p>Names</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>priv-libs</p></td>
<td><p>cybexp-priv-libs</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>collector</p></td>
<td><p>cybexp-collector</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>query</p></td>
<td><p>cybexp-priv-query</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>KMS</p></td>
<td><p>cybexp-kms-priv</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>backend API</p></td>
<td><p>cybexp-priv-backend-api</p></td>
</tr>
</tbody>
</table>
<p>All modules depend on the priv-libs image. please build this image first before building any other image. If importing images none of the building images apply.</p>
<p>All these images can be built manually by using docker’s build procedure. A wrapper script is provided to handle all building. Please build before running the first time, or when code was modified. Rebuilding is not necessary if the project has already been build or imported. Building is also not necessary when changing configuration scripts, as these are mounted at run time (also handled by wrapper scripts).</p>
</div>
<div class="section" id="build-base-image">
<h3>Build base image<a class="headerlink" href="#build-base-image" title="Permalink to this headline">¶</a></h3>
<p>To build the base image (cybexp-priv-libs):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> &lt;project-priv-libs&gt;
sh ./build.sh
</pre></div>
</div>
</div>
<div class="section" id="build-other-images">
<h3>Build other images<a class="headerlink" href="#build-other-images" title="Permalink to this headline">¶</a></h3>
<p>Use the wrapper script provided in the module folder to build.</p>
<p>One can use the wrapper script in the same way as running (please view run section) the module and supply the <code class="docutils literal notranslate"><span class="pre">--build</span></code> flag. If you want to only build you can also supply the <code class="docutils literal notranslate"><span class="pre">--build-only</span></code>. It is necessary to build before running the first time, this can also be done/combined when running the first time.</p>
<p>For example to build the collector:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> &lt;project-collector&gt;
bash collector.sh --build config.yaml
</pre></div>
</div>
<p>The  <code class="docutils literal notranslate"><span class="pre">secrets</span></code> folder that is located at the root of each module is mounted at runtime. It holds the keys. Each module has one. Keys are only fetched from the KMS server if they are not found there. One can mount an encrypted LUKS filesystem to the <code class="docutils literal notranslate"><span class="pre">secrets</span></code> folder before running this project to securely store these keys when they are at rest.</p>
<p>Secrets and configurations are never included in the images as they are mounted to the container at runtime.</p>
</div>
</div>
<div class="section" id="fetching-images-todo">
<h2>Fetching images TODO<a class="headerlink" href="#fetching-images-todo" title="Permalink to this headline">¶</a></h2>
<p>When fetching the images, the base image is not necessary as the images are bundled with the base image.</p>
<!-- ### Option 1 Export import save
[tutorial](https://stackoverflow.com/a/23938978/12044480)   
[docker export](https://docs.docker.com/engine/reference/commandline/export/)   

### Option 2 Docker registry
[docker registry](https://docs.docker.com/registry/deploying/)   
[How to use your own Registry tutorial](https://www.docker.com/blog/how-to-use-your-own-registry/) -->
</div>
</div>
<div class="section" id="running">
<h1>Running<a class="headerlink" href="#running" title="Permalink to this headline">¶</a></h1>
<div class="section" id="docker">
<h2>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h2>
<p>Most Linux distributions use <code class="docutils literal notranslate"><span class="pre">systemd</span></code> as service manager, the following commands apply. If your system uses <code class="docutils literal notranslate"><span class="pre">SystemV</span></code> please look <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-configure-a-linux-service-to-start-automatically-after-a-crash-or-reboot-part-2-reference">here</a>  for a brief tutorial.</p>
<p>Start docker service</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl start docker
</pre></div>
</div>
<p>Start docker at boot</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl <span class="nb">enable</span> docker
</pre></div>
</div>
<p>Don not start docker at boot</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl disable docker
</pre></div>
</div>
<p>Running the docker daemon manually also works, as long as the daemon is running when using this project.</p>
</div>
<div class="section" id="running-a-module-todo">
<h2>Running a module  TODO<a class="headerlink" href="#running-a-module-todo" title="Permalink to this headline">¶</a></h2>
<p>To run first build the base image and the desired module image(if building, disregard if importing images).</p>
<div class="section" id="configure">
<h3>Configure<a class="headerlink" href="#configure" title="Permalink to this headline">¶</a></h3>
<p>Create a  config file and configure. Each module provides an example configuration file. Each configuration file is commented.
Pass this file as an argument when executing the wrapper scrips, see each wrapper script helps information.</p>
<div class="section" id="more-on-configurations">
<h4>More on configurations<a class="headerlink" href="#more-on-configurations" title="Permalink to this headline">¶</a></h4>
<div class="section" id="server-urls">
<h5>Server URLS<a class="headerlink" href="#server-urls" title="Permalink to this headline">¶</a></h5>
<p>The format is a follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">procotol</span><span class="p">:</span><span class="o">//</span><span class="n">host</span><span class="p">:</span><span class="n">port</span>
</pre></div>
</div>
<p>Protocol can be either <code class="docutils literal notranslate"><span class="pre">http</span></code> or <code class="docutils literal notranslate"><span class="pre">https</span></code>. The server administrator will let you know.</p>
<blockquote>
<div><p>:warning: <strong>Note</strong>: There is no trailing <code class="docutils literal notranslate"><span class="pre">/</span></code></p>
</div></blockquote>
</div>
<div class="section" id="setting-up-the-encryption-policy-todo">
<h5>Setting up the encryption policy TODO<a class="headerlink" href="#setting-up-the-encryption-policy-todo" title="Permalink to this headline">¶</a></h5>
<!-- timestamp match
default match 
exeact match
regex match -->
<p>Policy matching is done according to the config file for the collector. One can use exact match or regex match for the name of the field. Encryption is done field wise. The config file also specifies what encryption policy is used for that field. Each record must have at least one index.</p>
<p>Please use the <code class="docutils literal notranslate"><span class="pre">-a</span></code> on the collector wrapper scrip to figure out available attributes. Then one can use <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code>, <code class="docutils literal notranslate"><span class="pre">parenthesis</span></code> to create the policy.
example of policy: <code class="docutils literal notranslate"><span class="pre">&quot;DEFAULT</span> <span class="pre">and</span> <span class="pre">RESEARCH&quot;</span></code>. With This example policy the person quering must be <code class="docutils literal notranslate"><span class="pre">&quot;DEFAULT</span> <span class="pre">and</span> <span class="pre">RESEARCH&quot;</span></code> to be able to decrypt that field.</p>
<!-- ##### Collector -->
</div>
</div>
</div>
<div class="section" id="run">
<h3>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p>Execute the respective wrapper script at the root of the module. Each wrapper script support the <code class="docutils literal notranslate"><span class="pre">-h</span></code> and the <code class="docutils literal notranslate"><span class="pre">--help</span></code> flag, which will output their help/usage information.</p>
<p>for example the query help information looks as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./query.sh -h
Create and run a docker container to query the encrypted backend. By default the container is left behind,
vacuum recommended. Build at least once or when code has changed.

Usage:
  ./query.sh [Options] config-file query output-file
  ./query.sh --build --build-only

Positional arguments:
  config-file           configuration file yaml
  query                 string representing any query value
  output-file           file where the unencrypted information is placed

Options arguments:
  -b, --build           build docker image
  --build-only          exit after building
  -s, --shell           run shell, ignores most flags
  -f, --from-time EPOCH integer epoch used as &gt; filter for the query
  -t, --to-time EPOCH   integer epoch used as &lt; filter for the query
  -l, --left-inclusive  modify the --from-time to be inclusive &gt;=
  -r, --right-inclusive modify the --to-time to be inclusive &lt;=
  -c, --vacuum          remove container upon exit. If more than one container
                        of this type exists, it will remove all
  -h, --help            print this help

</pre></div>
</div>
<p>when executing one can run as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./query.sh config.yaml <span class="s1">&#39;123.123.123.123&#39;</span> output
<span class="c1"># view output </span>
cat output
</pre></div>
</div>
<div class="section" id="id1">
<h4>Collector<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>The collector is a multi-part module. The collector has the encryption module and the gatherers which ship the information to the collection encryption module to be encrypted. To run the collector correctly one has to setup the encryption policy.</p>
<p>One has to start the Collector using <code class="docutils literal notranslate"><span class="pre">collector.sh</span></code>, then one can run mulple collector clients. The only requirement for a client is that they have to connect to the collector tcp socket and send one json record per connection.</p>
<p>A collector client is provided within the collector module. The dependencies are  <code class="docutils literal notranslate"><span class="pre">python3</span></code>, <code class="docutils literal notranslate"><span class="pre">python3-venv</span></code> and modules specified in <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> (install as specified below).</p>
<p>Install collector dependencies(for debian based like ubuntu):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt install -y python3 python3-venv
</pre></div>
</div>
<p>To run the collector client:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> collector-client

<span class="c1"># make python environmnet, do once</span>
python3 -m venv env 

<span class="c1"># then source environment, do when wanting to run project</span>
<span class="c1">#  or to install dependencies</span>
<span class="nb">source</span> env/bin/activate
<span class="c1"># note (env) at left hand side of the terminal</span>

<span class="c1"># install dependencies, do once</span>
pip install -r requirements.txt 

<span class="c1"># then run client</span>
<span class="c1">#python3 collector-client.py --host &lt;collector-host&gt; --port &lt;collector-port&gt; &lt;json-file&gt;</span>
<span class="c1"># when running collector on the same machine this script will default to it</span>
python3 collector-client.py &lt;json-file&gt;
</pre></div>
</div>
<p>Note: <code class="docutils literal notranslate"><span class="pre">collector-client.py</span></code> has a flag <code class="docutils literal notranslate"><span class="pre">--json-key</span></code>, it make it so it only sends that spesific key-data pair. For example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;$oid&quot;</span><span class="p">:</span> <span class="s2">&quot;5d659c2d34ecea6c769ec9ff&quot;</span><span class="p">},</span> <span class="nt">&quot;itype&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;session&quot;</span><span class="p">:</span> <span class="s2">&quot;17e8b9e02971&quot;</span><span class="p">,</span> <span class="nt">&quot;geoip&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;165.227.91.185&quot;</span><span class="p">,</span> <span class="nt">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">40.7214</span><span class="p">,</span> <span class="nt">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">-74.0052</span><span class="p">,</span> <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">40.7214</span><span class="p">,</span> <span class="nt">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">-74.0052</span><span class="p">},</span> <span class="nt">&quot;continent_code&quot;</span><span class="p">:</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="nt">&quot;timezone&quot;</span><span class="p">:</span> <span class="s2">&quot;America/New_York&quot;</span><span class="p">,</span> <span class="nt">&quot;country_code3&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="nt">&quot;country_code2&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="nt">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;10013&quot;</span><span class="p">,</span> <span class="nt">&quot;country_name&quot;</span><span class="p">:</span> <span class="s2">&quot;United States&quot;</span><span class="p">,</span> <span class="nt">&quot;city_name&quot;</span><span class="p">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span> <span class="nt">&quot;dma_code&quot;</span><span class="p">:</span> <span class="mi">501</span><span class="p">,</span> <span class="nt">&quot;region_name&quot;</span><span class="p">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span> <span class="nt">&quot;region_code&quot;</span><span class="p">:</span> <span class="s2">&quot;NY&quot;</span><span class="p">},</span> <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/cowrie/cowrie/var/log/cowrie/cowrie.json&quot;</span><span class="p">,</span> <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-08-27T20:51:18.993Z&quot;</span><span class="p">,</span> <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;beats_input_codec_plain_applied&quot;</span><span class="p">,</span> <span class="s2">&quot;geoip&quot;</span><span class="p">,</span> <span class="s2">&quot;beats_input_codec_json_applied&quot;</span><span class="p">],</span> <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-08-27T20:51:16.595926Z&quot;</span><span class="p">,</span> <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh-peavine&quot;</span><span class="p">},</span> <span class="nt">&quot;duration&quot;</span><span class="p">:</span> <span class="mf">120.02226901054382</span><span class="p">,</span> <span class="nt">&quot;eventid&quot;</span><span class="p">:</span> <span class="s2">&quot;cowrie.session.closed&quot;</span><span class="p">,</span> <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Connection lost after 120 seconds&quot;</span><span class="p">,</span> <span class="nt">&quot;beat&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh-peavine&quot;</span><span class="p">,</span> <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;6.5.4&quot;</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh-peavine&quot;</span><span class="p">},</span> <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">3165054</span><span class="p">,</span> <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nt">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;165.227.91.185&quot;</span><span class="p">,</span> <span class="nt">&quot;prospector&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">},</span> <span class="nt">&quot;sensor&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh-peavine&quot;</span><span class="p">},</span> <span class="nt">&quot;orgid&quot;</span><span class="p">:</span> <span class="s2">&quot;identity--f27df111-ca31-4700-99d4-2635b6c37851&quot;</span><span class="p">,</span> <span class="nt">&quot;timezone&quot;</span><span class="p">:</span> <span class="s2">&quot;US/Pacific&quot;</span><span class="p">,</span> <span class="nt">&quot;sub_type&quot;</span><span class="p">:</span> <span class="s2">&quot;x-unr-honeypot&quot;</span><span class="p">,</span> <span class="nt">&quot;_hash&quot;</span><span class="p">:</span> <span class="s2">&quot;ce1125ef568028d65ad444dd9a6dacf6a860b7a3d0a43ebabc0b03fb258c80db&quot;</span><span class="p">,</span> <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;raw--8d30f29e-9285-4790-ac57-bbba5aa56fbb&quot;</span><span class="p">,</span> <span class="nt">&quot;filters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;filter--ad8c8d0c-0b25-4100-855e-06350a59750c&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<p>The data that we are after is inside the <code class="docutils literal notranslate"><span class="pre">data</span></code> key, therfore we wouls use the tool as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 collector-client.py --json-key data &lt;json-file&gt;
</pre></div>
</div>
<p>this will result in only sending the following:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;session&quot;</span><span class="p">:</span> <span class="s2">&quot;17e8b9e02971&quot;</span><span class="p">,</span> <span class="nt">&quot;geoip&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;165.227.91.185&quot;</span><span class="p">,</span> <span class="nt">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">40.7214</span><span class="p">,</span> <span class="nt">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">-74.0052</span><span class="p">,</span> <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">40.7214</span><span class="p">,</span> <span class="nt">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">-74.0052</span><span class="p">},</span> <span class="nt">&quot;continent_code&quot;</span><span class="p">:</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="nt">&quot;timezone&quot;</span><span class="p">:</span> <span class="s2">&quot;America/New_York&quot;</span><span class="p">,</span> <span class="nt">&quot;country_code3&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="nt">&quot;country_code2&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="nt">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;10013&quot;</span><span class="p">,</span> <span class="nt">&quot;country_name&quot;</span><span class="p">:</span> <span class="s2">&quot;United States&quot;</span><span class="p">,</span> <span class="nt">&quot;city_name&quot;</span><span class="p">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span> <span class="nt">&quot;dma_code&quot;</span><span class="p">:</span> <span class="mi">501</span><span class="p">,</span> <span class="nt">&quot;region_name&quot;</span><span class="p">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span> <span class="nt">&quot;region_code&quot;</span><span class="p">:</span> <span class="s2">&quot;NY&quot;</span><span class="p">},</span> <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/cowrie/cowrie/var/log/cowrie/cowrie.json&quot;</span><span class="p">,</span> <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-08-27T20:51:18.993Z&quot;</span><span class="p">,</span> <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;beats_input_codec_plain_applied&quot;</span><span class="p">,</span> <span class="s2">&quot;geoip&quot;</span><span class="p">,</span> <span class="s2">&quot;beats_input_codec_json_applied&quot;</span><span class="p">],</span> <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2019-08-27T20:51:16.595926Z&quot;</span><span class="p">,</span> <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh-peavine&quot;</span><span class="p">},</span> <span class="nt">&quot;duration&quot;</span><span class="p">:</span> <span class="mf">120.02226901054382</span><span class="p">,</span> <span class="nt">&quot;eventid&quot;</span><span class="p">:</span> <span class="s2">&quot;cowrie.session.closed&quot;</span><span class="p">,</span> <span class="nt">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Connection lost after 120 seconds&quot;</span><span class="p">,</span> <span class="nt">&quot;beat&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh-peavine&quot;</span><span class="p">,</span> <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;6.5.4&quot;</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh-peavine&quot;</span><span class="p">},</span> <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">3165054</span><span class="p">,</span> <span class="nt">&quot;@version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nt">&quot;src_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;165.227.91.185&quot;</span><span class="p">,</span> <span class="nt">&quot;prospector&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">},</span> <span class="nt">&quot;sensor&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh-peavine&quot;</span><span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p>:warning: <strong>Collector</strong>: The collector index creation works well on the first level of the json structure(make sure thet indices are created only on the first level). It can encrypt on more levels on the tree but index retrieval/quering of the data might not be deterministic(due to sorting of the json structure) if index was a multilevel, therefore it may result on unquerable data!</p>
</div></blockquote>
</div>
</div>
</div>
</div>
<div class="section" id="troubleshooting">
<h1>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>If an error regarding <code class="docutils literal notranslate"><span class="pre">unix:///var/run/docker.sock</span></code> or permission denied, please make sure docker daemon/service is running.</p></li>
<li><p>If a module can not connect to another, make sure that the following configurations are correct:</p>
<ul>
<li><p>the bind interface of the server</p></li>
<li><p>the address of the server in the client configuration</p></li>
<li><p>for example if server is bound to its ip, it can not be accesses via localhost, even if they are the same machine. Use it’s ip</p></li>
<li><p>the address format (for clients) is as follows:</p>
<ul>
<li><p>protocol://hostname:port</p></li>
<li><p>no slash at the end</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="important">
<h1>Important<a class="headerlink" href="#important" title="Permalink to this headline">¶</a></h1>
<p>Regardless if you are building or fetching the images there are a few things that are required to run each image, here is table:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Module</p></th>
<th class="text-align:center head"><p>docker</p></th>
<th class="text-align:center head"><p>Building</p></th>
<th class="text-align:center head"><p>Configuration File</p></th>
<th class="text-align:center head"><p>DB</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>priv-libs</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>-</p></td>
<td class="text-align:center"><p>:x:</p></td>
<td class="text-align:center"><p>-</p></td>
</tr>
<tr class="row-odd"><td><p>collector</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>priv-lib</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>:x:</p></td>
</tr>
<tr class="row-even"><td><p>query</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>priv-lib</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>:x:</p></td>
</tr>
<tr class="row-odd"><td><p>KMS</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>priv-lib</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
</tr>
<tr class="row-even"><td><p>backend API</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>priv-lib</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
<td class="text-align:center"><p>:heavy_check_mark:</p></td>
</tr>
</tbody>
</table>
<!-- :heavy_check_mark:
:x: -->
<p>The wrapper scripts are not truly required but they are highly recommended.</p>
<p>The modules that have the DB marked need to use a mongo database, it can be configured in the configuration file. By default the wrapper spawns its own docker mongodb container. The database container has the directory <code class="docutils literal notranslate"><span class="pre">db</span></code> mounted at runtime. This directory is located at the root of the module. This directory contains the contents of the mongodb. All this can be configured with the docker-compose.yaml file.</p>
<!-- # TODO write sections

## Secrets
are stored and mounted here

## Config files are mounted this way and
each should be configured the folowing way
more documentation in each sample configuration file provided with each module. 

## Output is copied over here

## kms and backend have extra mongo database
There is a `db` folder used by the KMS and the backend API at their respective root folders. This folder is used by their database service. One can mount an encrypted LUKS filesystem to this folder before running the services, protecting the information at rest.

> :warning: **This is a test waning**: Be very careful here!

 --></div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Adam Cassell.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>